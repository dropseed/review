<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="
    default-src 'none';
    style-src 'unsafe-inline';
    script-src 'nonce-{{nonce}}';
  "
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        --accent-color: #3794a5;
        --accent-color-hover: #2d7a89;
        --accent-color-subtle: rgba(55, 148, 165, 0.1);
        --danger-color: #c74e4e;
        --danger-color-hover: #a83c3c;
        --success-color: #4caf50;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: var(--vscode-font-family), sans-serif;
        font-size: var(--vscode-font-size);
        color: var(--vscode-foreground);
        background: var(--vscode-sideBar-background);
        padding: 8px;
      }

      /* Focus styles - accessibility */
      :focus {
        outline: none;
      }

      :focus-visible {
        outline: 2px solid var(--vscode-focusBorder);
        outline-offset: 2px;
      }

      select:focus-visible,
      textarea:focus-visible,
      button:focus-visible {
        outline: 2px solid var(--vscode-focusBorder);
        outline-offset: 1px;
      }

      .container {
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      /* Progress indicator */
      .progress-section {
        flex-shrink: 0;
        padding: 8px 10px;
        background: var(--accent-color-subtle);
        border-radius: 4px;
        border-left: 3px solid var(--accent-color);
      }

      .progress-bar-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .progress-bar {
        flex: 1;
        height: 6px;
        background: var(--vscode-input-background);
        border-radius: 3px;
        overflow: hidden;
      }

      .progress-bar-fill {
        height: 100%;
        background: var(--accent-color);
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      .progress-text {
        font-size: 11px;
        color: var(--vscode-foreground);
        white-space: nowrap;
        font-variant-numeric: tabular-nums;
      }

      .progress-complete {
        color: var(--success-color);
        font-weight: 500;
      }

      /* Selectors */
      .selector {
        display: flex;
        gap: 12px;
        flex-shrink: 0;
      }

      .select-group {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .select-group label {
        font-size: 11px;
        color: var(--vscode-descriptionForeground);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .select-group select {
        width: 100%;
        padding: 4px 8px;
        font-family: var(--vscode-font-family), sans-serif;
        font-size: var(--vscode-font-size);
        color: var(--vscode-dropdown-foreground);
        background: var(--vscode-dropdown-background);
        border: 1px solid var(--vscode-dropdown-border, transparent);
        border-radius: 2px;
        cursor: pointer;
      }

      /* Notes section - primary content area */
      .notes-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-height: 0;
        margin-top: 4px;
      }

      .notes-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .notes-label {
        font-size: 11px;
        color: var(--vscode-descriptionForeground);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .save-indicator {
        font-size: 10px;
        color: var(--success-color);
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .save-indicator.visible {
        opacity: 1;
      }

      .notes-textarea {
        flex: 1;
        width: 100%;
        padding: 12px;
        font-family:
          "SF Mono", "Fira Code", "Cascadia Code", var(--vscode-editor-font-family), monospace;
        font-size: var(--vscode-font-size);
        line-height: 1.5;
        color: var(--vscode-input-foreground);
        background: var(--vscode-input-background);
        border: 1px solid var(--vscode-input-border, transparent);
        border-radius: 4px;
        resize: none;
      }

      .notes-textarea::placeholder {
        color: var(--vscode-input-placeholderForeground);
      }

      .notes-hint {
        font-size: 10px;
        color: var(--vscode-descriptionForeground);
      }

      .notes-hint kbd {
        display: inline-block;
        padding: 1px 4px;
        font-family: inherit;
        font-size: 10px;
        background: var(--vscode-badge-background);
        color: var(--vscode-badge-foreground);
        border-radius: 2px;
      }

      /* Buttons */
      .buttons {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }

      button {
        flex: 1;
        padding: 6px 12px;
        font-family: var(--vscode-font-family), sans-serif;
        font-size: var(--vscode-font-size);
        border: none;
        border-radius: 3px;
        cursor: pointer;
        transition:
          background-color 0.15s ease,
          opacity 0.15s ease;
      }

      .copy-btn {
        color: var(--vscode-button-secondaryForeground);
        background: var(--vscode-button-secondaryBackground);
      }

      .copy-btn:hover {
        background: var(--vscode-button-secondaryHoverBackground);
      }

      .clear-btn {
        flex: 0 0 auto;
        color: var(--danger-color);
        background: transparent;
        border: 1px solid var(--danger-color);
      }

      .clear-btn:hover {
        color: #fff;
        background: var(--danger-color);
      }

      /* Trust/Labels section - collapsible, below notes */
      .labels-section {
        flex-shrink: 0;
        border: 1px solid var(--vscode-panel-border, var(--vscode-input-border, transparent));
        border-radius: 4px;
        overflow: hidden;
      }

      .labels-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        background: var(--vscode-sideBarSectionHeader-background, transparent);
        cursor: pointer;
        user-select: none;
      }

      .labels-header:hover {
        background: var(--vscode-list-hoverBackground);
      }

      .labels-header-left {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .labels-header-title {
        font-size: 11px;
        color: var(--vscode-descriptionForeground);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .labels-header-count {
        font-size: 10px;
        color: var(--vscode-badge-foreground);
        background: var(--vscode-badge-background);
        padding: 1px 5px;
        border-radius: 8px;
      }

      .collapse-icon {
        font-size: 10px;
        color: var(--vscode-descriptionForeground);
        transition: transform 0.2s ease;
      }

      .labels-section.collapsed .collapse-icon {
        transform: rotate(-90deg);
      }

      .labels-content {
        max-height: 150px;
        overflow-y: auto;
        padding: 6px 10px;
        border-top: 1px solid var(--vscode-panel-border, var(--vscode-input-border, transparent));
      }

      .labels-section.collapsed .labels-content {
        display: none;
      }

      .labels-actions {
        display: flex;
        gap: 6px;
        padding: 6px 10px;
        border-top: 1px solid var(--vscode-panel-border, var(--vscode-input-border, transparent));
        background: var(--vscode-sideBarSectionHeader-background, transparent);
      }

      .labels-section.collapsed .labels-actions {
        display: none;
      }

      .label-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 2px;
        font-size: 12px;
        cursor: pointer;
        border-radius: 2px;
      }

      .label-item:hover {
        background: var(--vscode-list-hoverBackground);
      }

      .label-checkbox {
        cursor: pointer;
        accent-color: var(--accent-color);
      }

      .label-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .label-count {
        color: var(--vscode-descriptionForeground);
        font-size: 11px;
        font-variant-numeric: tabular-nums;
      }

      .no-labels {
        color: var(--vscode-descriptionForeground);
        font-size: 12px;
        font-style: italic;
        padding: 4px 0;
      }

      .classify-btn {
        flex: 1;
        padding: 4px 10px;
        font-size: 11px;
        font-family: var(--vscode-font-family), sans-serif;
        color: var(--vscode-button-foreground);
        background: var(--accent-color);
        border: none;
        border-radius: 3px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition:
          background-color 0.15s ease,
          opacity 0.15s ease;
      }

      .classify-btn:hover:not(:disabled) {
        background: var(--accent-color-hover);
      }

      .classify-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Loading spinner */
      .spinner {
        width: 12px;
        height: 12px;
        border: 2px solid transparent;
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Empty states */
      .empty-state {
        color: var(--vscode-descriptionForeground);
        font-size: 12px;
        padding: 16px;
        text-align: center;
      }

      /* Confirmation dialog */
      .confirm-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.15s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .confirm-dialog {
        background: var(--vscode-editor-background);
        border: 1px solid var(--vscode-panel-border);
        border-radius: 6px;
        padding: 16px;
        max-width: 280px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.15s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateY(-10px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .confirm-title {
        font-weight: 600;
        margin-bottom: 8px;
      }

      .confirm-message {
        font-size: 12px;
        color: var(--vscode-descriptionForeground);
        margin-bottom: 16px;
      }

      .confirm-buttons {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      .confirm-buttons button {
        flex: 0 0 auto;
        padding: 6px 14px;
      }

      .confirm-cancel {
        color: var(--vscode-button-secondaryForeground);
        background: var(--vscode-button-secondaryBackground);
      }

      .confirm-confirm {
        color: #fff;
        background: var(--danger-color);
      }

      .confirm-confirm:hover {
        background: var(--danger-color-hover);
      }

      /* Visually hidden for screen readers */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
  </head>
  <body>
    <div id="root" class="container" role="main" aria-label="Review panel"></div>
    <div id="dialog-root"></div>
    <script nonce="{{nonce}}">
      // Constants
      const WORKING_TREE = "__working_tree__";
      const HEAD = "__head__";
      const DEBOUNCE_MS = 500;
      const SAVE_INDICATOR_MS = 2000;
      const COPIED_INDICATOR_MS = 1500;

      // Consolidated state
      const state = {
        repositories: [],
        selectedRepo: "",
        branches: [],
        currentBranch: "",
        oldBranch: "",
        newBranch: "",
        notes: "",
        labels: [],
        unclassifiedCount: 0,
        isClassifying: false,
        labelsCollapsed: false,
        // Derived state
        totalHunks: 0,
        reviewedHunks: 0,
      };

      // UI state (not persisted)
      let notesTimeout = null;
      let saveIndicatorTimeout = null;
      let isInitialized = false;

      const vscode = acquireVsCodeApi();

      // Escape HTML to prevent XSS
      function escapeHtml(str) {
        if (!str) return "";
        const div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
      }

      // Escape for attribute values
      function escapeAttr(str) {
        if (!str) return "";
        return str.replace(/"/g, "&quot;").replace(/'/g, "&#39;");
      }

      // Show confirmation dialog
      function showConfirmDialog(title, message, onConfirm) {
        const dialogRoot = document.getElementById("dialog-root");
        dialogRoot.innerHTML = `
          <div class="confirm-overlay" id="confirm-overlay" role="alertdialog" aria-modal="true" aria-labelledby="confirm-title" aria-describedby="confirm-message">
            <div class="confirm-dialog">
              <div class="confirm-title" id="confirm-title">${escapeHtml(title)}</div>
              <div class="confirm-message" id="confirm-message">${escapeHtml(message)}</div>
              <div class="confirm-buttons">
                <button class="confirm-cancel" id="confirm-cancel" type="button">Cancel</button>
                <button class="confirm-confirm" id="confirm-confirm" type="button">Clear</button>
              </div>
            </div>
          </div>
        `;

        const overlay = document.getElementById("confirm-overlay");
        const cancelBtn = document.getElementById("confirm-cancel");
        const confirmBtn = document.getElementById("confirm-confirm");

        const close = () => {
          dialogRoot.innerHTML = "";
        };

        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) close();
        });

        cancelBtn.addEventListener("click", close);
        confirmBtn.addEventListener("click", () => {
          close();
          onConfirm();
        });

        // Focus the cancel button (safer default)
        cancelBtn.focus();

        // Handle escape key
        const handleKeydown = (e) => {
          if (e.key === "Escape") {
            close();
            document.removeEventListener("keydown", handleKeydown);
          }
        };
        document.addEventListener("keydown", handleKeydown);
      }

      // Show save indicator
      function showSaveIndicator() {
        const indicator = document.getElementById("save-indicator");
        if (indicator) {
          indicator.classList.add("visible");
          clearTimeout(saveIndicatorTimeout);
          saveIndicatorTimeout = setTimeout(() => {
            indicator.classList.remove("visible");
          }, SAVE_INDICATOR_MS);
        }
      }

      // Build progress section HTML
      function buildProgressHtml() {
        const total = state.totalHunks;
        const reviewed = state.reviewedHunks;

        if (total === 0) return "";

        const percent = Math.round((reviewed / total) * 100);
        const isComplete = reviewed === total;

        return `
          <section class="progress-section" aria-label="Review progress">
            <div class="progress-bar-container">
              <div class="progress-bar" role="progressbar" aria-valuenow="${reviewed}" aria-valuemin="0" aria-valuemax="${total}">
                <div class="progress-bar-fill" style="width: ${percent}%"></div>
              </div>
              <span class="progress-text ${isComplete ? "progress-complete" : ""}">
                ${reviewed}/${total} hunks${isComplete ? " âœ“" : ""}
              </span>
            </div>
          </section>
        `;
      }

      // Build repo selector HTML
      function buildRepoSelectorHtml() {
        if (state.repositories.length <= 1) return "";

        const options = state.repositories
          .map(
            (r) =>
              `<option value="${escapeAttr(r.path)}"${r.path === state.selectedRepo ? " selected" : ""}>${escapeHtml(r.name)}</option>`,
          )
          .join("");

        return `
          <div class="select-group" style="flex: none;">
            <label for="repo-select">Repository</label>
            <select id="repo-select">${options}</select>
          </div>
        `;
      }

      // Build branch selectors HTML
      function buildBranchSelectorsHtml() {
        const localBranches = state.branches.filter((b) => !b.includes("/"));
        const remoteBranches = state.branches.filter((b) => b.includes("/"));

        function branchOption(b, selected) {
          const isCurrent = b === state.currentBranch;
          return `<option value="${escapeAttr(b)}"${b === selected ? " selected" : ""}>${escapeHtml(b)}${isCurrent ? " (current)" : ""}</option>`;
        }

        let oldOptions = "";
        if (localBranches.length > 0) {
          oldOptions += `<optgroup label="Local">${localBranches.map((b) => branchOption(b, state.oldBranch)).join("")}</optgroup>`;
        }
        if (remoteBranches.length > 0) {
          oldOptions += `<optgroup label="Remote">${remoteBranches.map((b) => branchOption(b, state.oldBranch)).join("")}</optgroup>`;
        }

        let newOptions = `
          <optgroup label="Current">
            <option value="${WORKING_TREE}"${state.newBranch === WORKING_TREE ? " selected" : ""}>Working Tree</option>
            <option value="${HEAD}"${state.newBranch === HEAD ? " selected" : ""}>HEAD</option>
          </optgroup>
        `;
        if (localBranches.length > 0) {
          newOptions += `<optgroup label="Local">${localBranches.map((b) => branchOption(b, state.newBranch)).join("")}</optgroup>`;
        }
        if (remoteBranches.length > 0) {
          newOptions += `<optgroup label="Remote">${remoteBranches.map((b) => branchOption(b, state.newBranch)).join("")}</optgroup>`;
        }

        return `
          <div class="selector">
            <div class="select-group">
              <label for="old-select">Base</label>
              <select id="old-select">${oldOptions}</select>
            </div>
            <div class="select-group">
              <label for="new-select">Compare</label>
              <select id="new-select">${newOptions}</select>
            </div>
          </div>
        `;
      }

      // Build notes section HTML
      function buildNotesHtml() {
        return `
          <section class="notes-section" aria-label="Review notes">
            <div class="notes-header">
              <label for="notes-textarea" class="notes-label">Notes</label>
              <span id="save-indicator" class="save-indicator" aria-live="polite">Saved</span>
            </div>
            <textarea
              id="notes-textarea"
              class="notes-textarea"
              placeholder="Review notes\u2026"
              aria-describedby="notes-hint"
            >${escapeHtml(state.notes)}</textarea>
            <div class="notes-hint" id="notes-hint">
              <kbd>Cmd+Shift+R</kbd> adds line references from the editor
            </div>
          </section>
        `;
      }

      // Build buttons HTML
      function buildButtonsHtml() {
        return `
          <div class="buttons">
            <button type="button" class="copy-btn" id="copy-btn" aria-label="Copy notes as markdown">
              Copy
            </button>
            <button type="button" class="clear-btn" id="clear-btn" aria-label="Clear all notes">
              Clear
            </button>
          </div>
        `;
      }

      // Build labels section HTML
      function buildLabelsHtml() {
        const labelCount = state.labels.length;
        const collapsedClass = state.labelsCollapsed ? "collapsed" : "";

        let labelsContent;
        if (labelCount > 0) {
          labelsContent = state.labels
            .map(
              (l) => `
              <label class="label-item">
                <input type="checkbox" class="label-checkbox" id="label-${escapeAttr(l.name)}" data-label="${escapeAttr(l.name)}" ${l.trusted ? "checked" : ""}>
                <span class="label-name" title="${escapeAttr(l.name)}">${escapeHtml(l.name)}</span>
                <span class="label-count">${l.count}</span>
              </label>
            `,
            )
            .join("");
        } else {
          labelsContent = '<div class="no-labels">No labels yet</div>';
        }

        const classifyDisabled = state.unclassifiedCount === 0 || state.isClassifying;
        const classifyBtnContent = state.isClassifying
          ? '<span class="spinner" aria-hidden="true"></span> Classifying\u2026'
          : state.unclassifiedCount > 0
            ? `Classify (${state.unclassifiedCount})`
            : "Classify";

        return `
          <section class="labels-section ${collapsedClass}" aria-label="Trust labels">
            <div class="labels-header" id="labels-header" role="button" tabindex="0" aria-expanded="${!state.labelsCollapsed}" aria-controls="labels-content">
              <div class="labels-header-left">
                <span class="collapse-icon" aria-hidden="true">\u25BC</span>
                <span class="labels-header-title">Trust Labels</span>
                ${labelCount > 0 ? `<span class="labels-header-count">${labelCount}</span>` : ""}
              </div>
            </div>
            <div class="labels-content" id="labels-content">
              ${labelsContent}
            </div>
            <div class="labels-actions">
              <button
                type="button"
                id="classify-btn"
                class="classify-btn"
                ${classifyDisabled ? "disabled" : ""}
                aria-label="${state.isClassifying ? "Classification in progress" : `Classify ${state.unclassifiedCount} unclassified hunks`}"
              >
                ${classifyBtnContent}
              </button>
            </div>
          </section>
        `;
      }

      // Full render
      function render() {
        const root = document.getElementById("root");

        if (state.branches.length === 0) {
          root.innerHTML = '<div class="empty-state">Loading\u2026</div>';
          return;
        }

        root.innerHTML =
          buildRepoSelectorHtml() +
          buildBranchSelectorsHtml() +
          buildProgressHtml() +
          buildNotesHtml() +
          buildButtonsHtml() +
          buildLabelsHtml();

        // Mark as initialized after first render
        isInitialized = true;
      }

      // Targeted updates for specific sections
      function updateNotesValue() {
        const textarea = document.getElementById("notes-textarea");
        if (textarea && document.activeElement !== textarea) {
          textarea.value = state.notes;
        }
      }

      function updateLabelsSection() {
        const section = document.querySelector(".labels-section");
        if (section) {
          const temp = document.createElement("div");
          temp.innerHTML = buildLabelsHtml();
          const newSection = temp.firstElementChild;
          section.replaceWith(newSection);
        }
      }

      function updateProgressSection() {
        const section = document.querySelector(".progress-section");
        const progressHtml = buildProgressHtml();

        if (section && progressHtml) {
          const temp = document.createElement("div");
          temp.innerHTML = progressHtml;
          section.replaceWith(temp.firstElementChild);
        } else if (!section && progressHtml) {
          // Insert after branch selectors
          const selector = document.querySelector(".selector");
          if (selector) {
            const temp = document.createElement("div");
            temp.innerHTML = progressHtml;
            selector.insertAdjacentElement("afterend", temp.firstElementChild);
          }
        }
      }

      // Event delegation - single setup
      function setupEventDelegation() {
        const root = document.getElementById("root");

        root.addEventListener("change", (e) => {
          const target = e.target;

          if (target.id === "repo-select") {
            state.selectedRepo = target.value;
            state.oldBranch = "";
            state.newBranch = "";
            saveState();
            vscode.postMessage({ type: "selectRepository", repoPath: state.selectedRepo });
          } else if (target.id === "old-select") {
            state.oldBranch = target.value;
            saveState();
            sendComparison();
          } else if (target.id === "new-select") {
            state.newBranch = target.value;
            saveState();
            sendComparison();
          } else if (target.classList.contains("label-checkbox")) {
            const labelName = target.dataset.label;
            const isTrusted = target.checked;
            vscode.postMessage({
              type: isTrusted ? "trustLabel" : "untrustLabel",
              label: labelName,
            });
          }
        });

        root.addEventListener("input", (e) => {
          const target = e.target;

          if (target.id === "notes-textarea") {
            state.notes = target.value;
            saveState();

            clearTimeout(notesTimeout);
            notesTimeout = setTimeout(() => {
              vscode.postMessage({ type: "updateNotes", notes: state.notes });
              showSaveIndicator();
            }, DEBOUNCE_MS);
          }
        });

        root.addEventListener("keydown", (e) => {
          const target = e.target;

          // List continuation for notes
          if (target.id === "notes-textarea" && e.key === "Enter") {
            const pos = target.selectionStart;
            const text = target.value;
            const lineStart = text.lastIndexOf("\n", pos - 1) + 1;
            const line = text.slice(lineStart, pos);

            const match = line.match(/^(\s*-\s)/);
            if (match) {
              e.preventDefault();
              const prefix = match[1];
              const before = text.slice(0, pos);
              const after = text.slice(pos);
              target.value = `${before}\n${prefix}${after}`;
              const newPos = pos + 1 + prefix.length;
              target.setSelectionRange(newPos, newPos);
              state.notes = target.value;
              saveState();
              vscode.postMessage({ type: "updateNotes", notes: state.notes });
            }
          }

          // Labels header toggle with keyboard
          if (target.id === "labels-header" && (e.key === "Enter" || e.key === " ")) {
            e.preventDefault();
            toggleLabelsSection();
          }
        });

        root.addEventListener("click", (e) => {
          const target = e.target;

          if (target.id === "copy-btn" || target.closest("#copy-btn")) {
            vscode.postMessage({ type: "copy" });
          } else if (target.id === "clear-btn" || target.closest("#clear-btn")) {
            showConfirmDialog(
              "Clear Notes",
              "Are you sure you want to clear all review notes? This cannot be undone.",
              () => {
                vscode.postMessage({ type: "clear" });
              },
            );
          } else if (target.id === "classify-btn" || target.closest("#classify-btn")) {
            const btn = document.getElementById("classify-btn");
            if (btn && !btn.disabled) {
              vscode.postMessage({ type: "classify" });
            }
          } else if (target.id === "labels-header" || target.closest("#labels-header")) {
            toggleLabelsSection();
          }
        });
      }

      function toggleLabelsSection() {
        state.labelsCollapsed = !state.labelsCollapsed;
        const section = document.querySelector(".labels-section");
        const header = document.getElementById("labels-header");
        if (section) {
          section.classList.toggle("collapsed", state.labelsCollapsed);
        }
        if (header) {
          header.setAttribute("aria-expanded", !state.labelsCollapsed);
        }
        saveState();
      }

      function saveState() {
        vscode.setState({
          selectedRepo: state.selectedRepo,
          oldBranch: state.oldBranch,
          newBranch: state.newBranch,
          notes: state.notes,
          labelsCollapsed: state.labelsCollapsed,
        });
      }

      function sendComparison() {
        if (!state.oldBranch || !state.newBranch) return;

        let spec;
        if (state.newBranch === WORKING_TREE) {
          spec = { type: "working_tree", base: state.oldBranch };
        } else {
          const compare = state.newBranch === HEAD ? "HEAD" : state.newBranch;
          spec = { type: "branch", base: state.oldBranch, compare };
        }
        vscode.postMessage({ type: "selectComparison", spec });
      }

      // Message handler
      window.addEventListener("message", (e) => {
        const msg = e.data;

        switch (msg.type) {
          case "repositoriesLoaded":
            state.repositories = msg.repositories || [];
            if (!state.selectedRepo && msg.selectedRepo) {
              state.selectedRepo = msg.selectedRepo;
            }
            if (isInitialized) {
              render();
            }
            break;

          case "branchesLoaded":
            state.branches = msg.branches || [];
            state.currentBranch = msg.currentBranch || "";
            if (!state.oldBranch && state.branches.length > 0) {
              state.oldBranch =
                state.branches.find(
                  (b) =>
                    b === "main" || b === "master" || b === "origin/main" || b === "origin/master",
                ) || state.branches[0];
            }
            if (!state.newBranch) {
              state.newBranch = WORKING_TREE;
            }
            render();
            sendComparison();
            break;

          case "noRepository":
            document.getElementById("root").innerHTML =
              '<div class="empty-state">No Git repository found</div>';
            break;

          case "notesLoaded":
            state.notes = msg.notes || "";
            updateNotesValue();
            saveState();
            break;

          case "copied": {
            const btn = document.getElementById("copy-btn");
            if (btn) {
              const original = btn.textContent;
              btn.textContent = "Copied!";
              btn.setAttribute("aria-label", "Copied to clipboard");
              setTimeout(() => {
                btn.textContent = original;
                btn.setAttribute("aria-label", "Copy notes as markdown");
              }, COPIED_INDICATOR_MS);
            }
            break;
          }

          case "referenceAdded": {
            let ref = `${msg.reference} `;
            if (state.notes.length > 0) {
              const lastChar = state.notes[state.notes.length - 1];
              if (lastChar !== "\n" && lastChar !== " ") {
                ref = ` ${ref}`;
              }
            }
            state.notes = state.notes + ref;
            const textarea = document.getElementById("notes-textarea");
            if (textarea) {
              textarea.value = state.notes;
              textarea.focus();
              textarea.setSelectionRange(state.notes.length, state.notes.length);
            }
            saveState();
            vscode.postMessage({ type: "updateNotes", notes: state.notes });
            break;
          }

          case "labelsLoaded":
            state.labels = msg.labels || [];
            state.unclassifiedCount = msg.unclassifiedCount || 0;
            if (isInitialized) {
              updateLabelsSection();
            }
            break;

          case "progressUpdate":
            state.totalHunks = msg.total || 0;
            state.reviewedHunks = msg.reviewed || 0;
            if (isInitialized) {
              updateProgressSection();
            }
            break;

          case "classifyStarted":
            state.isClassifying = true;
            if (isInitialized) {
              updateLabelsSection();
            }
            break;

          case "classifyComplete":
          case "classifyFailed":
            state.isClassifying = false;
            if (isInitialized) {
              updateLabelsSection();
            }
            break;
        }
      });

      // Restore state
      const saved = vscode.getState();
      if (saved) {
        state.selectedRepo = saved.selectedRepo || "";
        state.oldBranch = saved.oldBranch || "";
        state.newBranch = saved.newBranch || "";
        state.notes = saved.notes || "";
        state.labelsCollapsed = saved.labelsCollapsed || false;
      }

      // Setup event delegation once
      setupEventDelegation();

      // Initial load
      vscode.postMessage({ type: "ready" });
    </script>
  </body>
</html>
