#!/bin/bash
# Performance benchmarks for Review.
#
# Usage:
#   scripts/bench                     # default: HEAD~5..HEAD
#   scripts/bench <old_ref> <new_ref> # custom range

set -e
cd "$(dirname "$0")/.."

OLD_REF="${1:-HEAD~5}"
NEW_REF="${2:-HEAD}"

echo "========================================"
echo " Hunk loading: per-file vs batch diff"
echo "========================================"
echo ""
cargo run --release --example bench_hunk_loading -- "$OLD_REF" "$NEW_REF"

echo ""
echo "========================================"
echo " Line counting: split() vs indexOf()"
echo "========================================"
echo ""
node -e '
const sizes = [100, 1000, 5000, 20000];
for (const n of sizes) {
  const lines = Array.from({ length: n }, (_, i) =>
    "line " + i + ": " + "x".repeat(40 + (i % 60))
  );
  const content = lines.join("\n");

  const runs = 500;

  const tA0 = performance.now();
  let rA;
  for (let i = 0; i < runs; i++) rA = content.split("\n").length;
  const tA = (performance.now() - tA0) / runs;

  const tB0 = performance.now();
  let rB;
  for (let i = 0; i < runs; i++) {
    let c = 1, idx = -1;
    while ((idx = content.indexOf("\n", idx + 1)) !== -1) c++;
    rB = c;
  }
  const tB = (performance.now() - tB0) / runs;

  const speedup = tA / tB;
  console.log(
    String(n).padStart(6) + " lines (" +
    (content.length / 1024).toFixed(0).padStart(4) + " KB): " +
    "split=" + tA.toFixed(3) + "ms  " +
    "indexOf=" + tB.toFixed(3) + "ms  " +
    "speedup=" + speedup.toFixed(1) + "x  " +
    (rA === rB ? "OK" : "MISMATCH")
  );
}
'
