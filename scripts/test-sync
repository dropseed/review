#!/bin/bash
# E2E test for sync server workflow
#
# This script tests the sync server API endpoints using curl.
# It requires the sync server to be running with a known auth token.
#
# Usage:
#   scripts/test-sync [server_url] [auth_token]
#
# Example:
#   scripts/test-sync http://localhost:17950 my-test-token

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Default values
SERVER_URL="${1:-http://localhost:17950}"
AUTH_TOKEN="${2:-test-auth-token}"

echo "====================================="
echo "Sync Server E2E Tests"
echo "====================================="
echo "Server: $SERVER_URL"
echo ""

# Test counter
TESTS_PASSED=0
TESTS_FAILED=0

# Test function
run_test() {
    local name="$1"
    local expected_status="$2"
    local method="${3:-GET}"
    local endpoint="$4"
    local data="$5"

    echo -n "Testing: $name... "

    if [ "$method" = "GET" ]; then
        response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $AUTH_TOKEN" \
            "$SERVER_URL$endpoint" 2>/dev/null)
    elif [ "$method" = "PATCH" ]; then
        response=$(curl -s -w "\n%{http_code}" \
            -X PATCH \
            -H "Authorization: Bearer $AUTH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$data" \
            "$SERVER_URL$endpoint" 2>/dev/null)
    fi

    status_code=$(echo "$response" | tail -n 1)
    body=$(echo "$response" | sed '$d')

    if [ "$status_code" = "$expected_status" ]; then
        echo -e "${GREEN}PASSED${NC} (HTTP $status_code)"
        ((TESTS_PASSED++))
        return 0
    else
        echo -e "${RED}FAILED${NC} (expected $expected_status, got $status_code)"
        echo "  Response: $body"
        ((TESTS_FAILED++))
        return 1
    fi
}

# Test function for checking response content
run_test_with_body() {
    local name="$1"
    local expected_status="$2"
    local endpoint="$3"
    local expected_content="$4"

    echo -n "Testing: $name... "

    response=$(curl -s -w "\n%{http_code}" \
        -H "Authorization: Bearer $AUTH_TOKEN" \
        "$SERVER_URL$endpoint" 2>/dev/null)

    status_code=$(echo "$response" | tail -n 1)
    body=$(echo "$response" | sed '$d')

    if [ "$status_code" != "$expected_status" ]; then
        echo -e "${RED}FAILED${NC} (expected status $expected_status, got $status_code)"
        ((TESTS_FAILED++))
        return 1
    fi

    if echo "$body" | grep -q "$expected_content"; then
        echo -e "${GREEN}PASSED${NC} (HTTP $status_code, found '$expected_content')"
        ((TESTS_PASSED++))
        return 0
    else
        echo -e "${RED}FAILED${NC} (expected content '$expected_content' not found)"
        echo "  Response: $body"
        ((TESTS_FAILED++))
        return 1
    fi
}

echo ""
echo "--- Health & Info Tests ---"

# Test 1: Health check (no auth required typically, but our impl requires it)
run_test_with_body "Health check" "200" "/api/health" '"ok":true'

# Test 2: Server info
run_test_with_body "Server info" "200" "/api/server/info" '"version"'

echo ""
echo "--- Auth Tests ---"

# Test 3: Missing auth should fail
echo -n "Testing: Missing auth header... "
response=$(curl -s -w "\n%{http_code}" "$SERVER_URL/api/repos" 2>/dev/null)
status_code=$(echo "$response" | tail -n 1)
if [ "$status_code" = "401" ]; then
    echo -e "${GREEN}PASSED${NC} (correctly rejected)"
    ((TESTS_PASSED++))
else
    echo -e "${RED}FAILED${NC} (expected 401, got $status_code)"
    ((TESTS_FAILED++))
fi

# Test 4: Wrong auth should fail
echo -n "Testing: Wrong auth token... "
response=$(curl -s -w "\n%{http_code}" \
    -H "Authorization: Bearer wrong-token" \
    "$SERVER_URL/api/repos" 2>/dev/null)
status_code=$(echo "$response" | tail -n 1)
if [ "$status_code" = "401" ]; then
    echo -e "${GREEN}PASSED${NC} (correctly rejected)"
    ((TESTS_PASSED++))
else
    echo -e "${RED}FAILED${NC} (expected 401, got $status_code)"
    ((TESTS_FAILED++))
fi

echo ""
echo "--- Repository Tests ---"

# Test 5: List repos
run_test "List repositories" "200" "GET" "/api/repos"

# Test 6: List clients
run_test "List connected clients" "200" "GET" "/api/server/clients"

echo ""
echo "--- Taxonomy Tests ---"

# Test 7: Get trust taxonomy
run_test_with_body "Get taxonomy" "200" "/api/taxonomy" '"patterns"'

echo ""
echo "--- Error Handling Tests ---"

# Test 8: Invalid repo ID
run_test "Invalid repo ID" "400" "GET" "/api/repos/not-valid-base64!"

# Test 9: Invalid comparison key format
# Encode a valid repo path first
REPO_PATH="/tmp/test-repo"
ENCODED_REPO=$(echo -n "$REPO_PATH" | base64 | tr '+/' '-_' | tr -d '=')
run_test "Invalid comparison key" "400" "GET" "/api/comparisons/$ENCODED_REPO/invalid-key-no-dots"

echo ""
echo "====================================="
echo "Test Results"
echo "====================================="
echo -e "Passed: ${GREEN}$TESTS_PASSED${NC}"
echo -e "Failed: ${RED}$TESTS_FAILED${NC}"
echo ""

if [ $TESTS_FAILED -gt 0 ]; then
    echo -e "${RED}Some tests failed!${NC}"
    exit 1
else
    echo -e "${GREEN}All tests passed!${NC}"
    exit 0
fi
