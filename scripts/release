#!/bin/bash
set -e
cd "$(dirname "$0")/.."

BUMP="$1"

if [ "$BUMP" != "patch" ] && [ "$BUMP" != "minor" ]; then
    echo "Usage: scripts/release <patch|minor>"
    echo "Example: scripts/release patch"
    exit 1
fi

# Gate: run checks before anything else
echo "Running pre-commit checks..."
scripts/pre-commit

echo "Running tests..."
scripts/test

# Read current version from package.json
CURRENT=$(grep '"version"' desktop/package.json | head -1 | sed 's/.*"version": "\([^"]*\)".*/\1/')
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

case "$BUMP" in
    minor)
        MINOR=$((MINOR + 1))
        PATCH=0
        ;;
    patch)
        PATCH=$((PATCH + 1))
        ;;
esac

VERSION="${MAJOR}.${MINOR}.${PATCH}"
echo ""
echo "Bumping version: $CURRENT -> $VERSION"

# Update desktop/package.json
sed -i '' 's/"version": "[^"]*"/"version": "'"$VERSION"'"/' desktop/package.json

# Update core/Cargo.toml (only the package version, not dependency versions)
awk -v ver="$VERSION" '!done && /^version = "/ { sub(/^version = "[^"]*"/, "version = \"" ver "\""); done=1 } 1' core/Cargo.toml > core/Cargo.toml.tmp && mv core/Cargo.toml.tmp core/Cargo.toml

# Update desktop/tauri/Cargo.toml (only the package version, not dependency versions)
awk -v ver="$VERSION" '!done && /^version = "/ { sub(/^version = "[^"]*"/, "version = \"" ver "\""); done=1 } 1' desktop/tauri/Cargo.toml > desktop/tauri/Cargo.toml.tmp && mv desktop/tauri/Cargo.toml.tmp desktop/tauri/Cargo.toml

# Update desktop/tauri/tauri.conf.json
sed -i '' 's/"version": "[^"]*"/"version": "'"$VERSION"'"/' desktop/tauri/tauri.conf.json

# Update Cargo.lock
echo "Running cargo check to update Cargo.lock..."
cargo check --manifest-path desktop/tauri/Cargo.toml 2>/dev/null

echo ""
echo "Updated versions:"
echo "  desktop/package.json:          $(grep '"version"' desktop/package.json | head -1 | xargs)"
echo "  core/Cargo.toml:               $(grep '^version' core/Cargo.toml | head -1 | xargs)"
echo "  desktop/tauri/Cargo.toml:      $(grep '^version' desktop/tauri/Cargo.toml | head -1 | xargs)"
echo "  desktop/tauri/tauri.conf.json: $(grep '"version"' desktop/tauri/tauri.conf.json | xargs)"

# Fetch signing secrets from 1Password
echo ""
echo "Fetching signing secrets from 1Password..."
TAURI_SIGNING_PRIVATE_KEY=$(op read "op://Dropseed/c6fvj2hcdkxkyzi6mvym5aimge/review.key")
TAURI_SIGNING_PRIVATE_KEY_PASSWORD=$(op read "op://Dropseed/c6fvj2hcdkxkyzi6mvym5aimge/password")
export TAURI_SIGNING_PRIVATE_KEY
export TAURI_SIGNING_PRIVATE_KEY_PASSWORD

# Fetch Apple code signing and notarization credentials from 1Password
echo "Fetching Apple signing credentials from 1Password..."
APPLE_SIGNING_IDENTITY=$(op read "op://Dropseed/c6fvj2hcdkxkyzi6mvym5aimge/APPLE_SIGNING_IDENTITY")
APPLE_ID=$(op read "op://Dropseed/c6fvj2hcdkxkyzi6mvym5aimge/APPLE_ID")
APPLE_PASSWORD=$(op read "op://Dropseed/c6fvj2hcdkxkyzi6mvym5aimge/APPLE_PASSWORD")
APPLE_TEAM_ID=$(op read "op://Dropseed/c6fvj2hcdkxkyzi6mvym5aimge/APPLE_TEAM_ID")
export APPLE_SIGNING_IDENTITY
export APPLE_ID
export APPLE_PASSWORD
export APPLE_TEAM_ID

# Pre-build sidecar binaries for both targets (Tauri's beforeBuildCommand
# only runs once, so the second target would be missing its sidecar)
echo ""
echo "Building sidecar binaries..."
TAURI_TARGET_TRIPLE=aarch64-apple-darwin ./scripts/build-cli
TAURI_TARGET_TRIPLE=x86_64-apple-darwin ./scripts/build-cli

# Build both targets
echo ""
echo "Building aarch64-apple-darwin..."
(cd desktop && npm run tauri build -- --target aarch64-apple-darwin --features symbols-all)
# Detach any auto-mounted DMGs to prevent Finder from opening
hdiutil detach /Volumes/Review 2>/dev/null || true

echo ""
echo "Building x86_64-apple-darwin..."
(cd desktop && npm run tauri build -- --target x86_64-apple-darwin --features symbols-all)
hdiutil detach /Volumes/Review 2>/dev/null || true

echo ""
echo "Both builds succeeded!"

# Commit, tag, and push (only after builds succeed)
git add desktop/package.json core/Cargo.toml desktop/tauri/Cargo.toml desktop/tauri/tauri.conf.json Cargo.lock
git commit -m "Release v$VERSION"
git tag -m "v$VERSION" "v$VERSION"

echo ""
echo "Created commit and tag v$VERSION"

git push && git push --tags

echo ""
echo "Pushed to remote."
echo ""
echo "Build, tag, and push complete for v$VERSION."
echo "Run scripts/gh-release to create the GitHub release."
