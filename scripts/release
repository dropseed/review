#!/bin/bash
set -e
cd "$(dirname "$0")/.."

BUMP="$1"

if [ "$BUMP" != "patch" ] && [ "$BUMP" != "minor" ]; then
    echo "Usage: scripts/release <patch|minor>"
    echo "Example: scripts/release patch"
    exit 1
fi

# Gate: run checks before anything else
echo "Running pre-commit checks..."
scripts/pre-commit

echo "Running tests..."
scripts/test

# Read current version from package.json
CURRENT=$(grep '"version"' package.json | head -1 | sed 's/.*"version": "\([^"]*\)".*/\1/')
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

case "$BUMP" in
    minor)
        MINOR=$((MINOR + 1))
        PATCH=0
        ;;
    patch)
        PATCH=$((PATCH + 1))
        ;;
esac

VERSION="${MAJOR}.${MINOR}.${PATCH}"
echo ""
echo "Bumping version: $CURRENT -> $VERSION"

# Update package.json
sed -i '' 's/"version": "[^"]*"/"version": "'"$VERSION"'"/' package.json

# Update review/Cargo.toml (only the package version, not dependency versions)
awk -v ver="$VERSION" '!done && /^version = "/ { sub(/^version = "[^"]*"/, "version = \"" ver "\""); done=1 } 1' review/Cargo.toml > review/Cargo.toml.tmp && mv review/Cargo.toml.tmp review/Cargo.toml

# Update src-tauri/Cargo.toml (only the package version, not dependency versions)
awk -v ver="$VERSION" '!done && /^version = "/ { sub(/^version = "[^"]*"/, "version = \"" ver "\""); done=1 } 1' src-tauri/Cargo.toml > src-tauri/Cargo.toml.tmp && mv src-tauri/Cargo.toml.tmp src-tauri/Cargo.toml

# Update src-tauri/tauri.conf.json
sed -i '' 's/"version": "[^"]*"/"version": "'"$VERSION"'"/' src-tauri/tauri.conf.json

# Update Cargo.lock
echo "Running cargo check to update Cargo.lock..."
cargo check --manifest-path src-tauri/Cargo.toml 2>/dev/null

echo ""
echo "Updated versions:"
echo "  package.json:          $(grep '"version"' package.json | head -1 | xargs)"
echo "  review/Cargo.toml:     $(grep '^version' review/Cargo.toml | head -1 | xargs)"
echo "  src-tauri/Cargo.toml:  $(grep '^version' src-tauri/Cargo.toml | head -1 | xargs)"
echo "  src-tauri/tauri.conf.json: $(grep '"version"' src-tauri/tauri.conf.json | xargs)"

# Fetch signing secrets from 1Password
echo ""
echo "Fetching signing secrets from 1Password..."
TAURI_SIGNING_PRIVATE_KEY=$(op document get vzul5rmugullupaix5xmwrugni --vault Dropseed)
TAURI_SIGNING_PRIVATE_KEY_PASSWORD=$(op read "op://Dropseed/c6fvj2hcdkxkyzi6mvym5aimge/password")
export TAURI_SIGNING_PRIVATE_KEY
export TAURI_SIGNING_PRIVATE_KEY_PASSWORD

# Build both targets
echo ""
echo "Building aarch64-apple-darwin..."
npm run tauri build -- --target aarch64-apple-darwin --features symbols-all

echo ""
echo "Building x86_64-apple-darwin..."
npm run tauri build -- --target x86_64-apple-darwin --features symbols-all

echo ""
echo "Both builds succeeded!"

# Commit, tag, and push (only after builds succeed)
git add package.json review/Cargo.toml src-tauri/Cargo.toml src-tauri/tauri.conf.json Cargo.lock
git commit -m "v$VERSION"
git tag -m "v$VERSION" "v$VERSION"

echo ""
echo "Created commit and tag v$VERSION"

git push && git push --tags

echo ""
echo "Pushed to remote."

# Create GitHub release with artifacts
AARCH64_DIR="target/aarch64-apple-darwin/release/bundle"
X86_64_DIR="target/x86_64-apple-darwin/release/bundle"

gh release create "v$VERSION" --draft --title "v$VERSION" \
    "$AARCH64_DIR/dmg/Review_${VERSION}_aarch64.dmg" \
    "$AARCH64_DIR/macos/Review.app.tar.gz" \
    "$AARCH64_DIR/macos/Review.app.tar.gz.sig" \
    "$X86_64_DIR/dmg/Review_${VERSION}_x86_64.dmg" \
    "$X86_64_DIR/macos/Review.app.tar.gz" \
    "$X86_64_DIR/macos/Review.app.tar.gz.sig" \
    "$AARCH64_DIR/macos/latest.json"

echo ""
echo "Draft release created for v$VERSION"
echo "Visit https://github.com/dropseed/review/releases to publish it."
